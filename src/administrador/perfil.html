<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Perfil del Empleado</title>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

<style>
body { margin: 0; font-family: 'Arial', sans-serif; background: #f3f0e7; }
.header-img { width: 100%; height: 160px; background: linear-gradient(135deg,#d5c4b4,#f3e9dd); display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:bold; color:#5a4a42; }
.profile-wrapper { display:flex; justify-content:center; margin-top:-40px; }
.profile-img { width:100px; height:100px; border-radius:50%; border:3px solid #fff; background:#fff; object-fit:cover; }
.container { background:#fff8f0; margin:20px auto; padding:25px; border-radius:10px; max-width:600px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
.title-bar { background:#5a4a42; color:#fff; padding:12px; font-weight:bold; border-radius:6px 6px 0 0; margin-bottom:15px; text-align:center; font-size:18px; }
.data-grid { display:grid; grid-template-columns:1fr 1fr; gap:15px; }
label { font-weight:bold; font-size:14px; margin-bottom:5px; display:block; }
input { background:#f7f1e6; padding:10px; border-radius:5px; font-size:15px; border:1px solid #d1c1b3; width:100%; transition:background 0.3s,border 0.3s; }
input:focus { outline:none; border-color:#a07b5b; background:#fff2e6; }
input[readonly] { background:#e0d6c9; border-color:#ccc2b5; cursor:not-allowed; }
button { margin-top:20px; padding:10px 18px; background:#5a4a42; color:white; border:none; border-radius:6px; cursor:pointer; font-size:15px; width:100%; transition:background 0.3s; }
button:hover { background:#4a3d36; }
button:disabled { background:#999; cursor:not-allowed; }
.error { color:red; font-size:13px; margin-top:3px; grid-column:1 / -1; }
.debug { margin-top:10px; font-size:14px; color:#333; background:#eee; padding:10px; border-radius:6px; white-space:pre-wrap; }
/* Para que la contraseña ocupe todo el ancho */
.grid-full { grid-column: 1 / -1; }
</style>
</head>

<body>
<div id="app">

    <div class="header-img">Perfil del Empleado</div>

    <div class="profile-wrapper">
        <img class="profile-img" src="../../media/perfil.png" alt="Foto de Perfil">
    </div>

    <div class="container">
        <div class="title-bar">Datos Personales</div>

        <div class="data-grid">
            <div><label>Nombre 1</label><input v-model="form.nombre1" :readonly="!editando"></div>
            <div><label>Nombre 2</label><input v-model="form.nombre2" :readonly="!editando"></div>
            <div><label>Apellido Paterno</label><input v-model="form.apellidoP" :readonly="!editando"></div>
            <div><label>Apellido Materno</label><input v-model="form.apellidoM" :readonly="!editando"></div>
            <div><label>Correo</label><input type="email" v-model="form.correo" :readonly="!editando"></div>
            <div><label>Dirección</label><input v-model="form.direccion" :readonly="!editando"></div>
            <div>
                <label>Teléfono</label>
                <input v-model="form.telefono" maxlength="10" @input="validarTelefono" :readonly="!editando">
                <span class="error" v-if="errores.telefono">{{ errores.telefono }}</span>
            </div>
            <div class="grid-full">
                <label>Nueva Contraseña (dejar vacío si no quieres cambiarla)</label>
                <input type="password" v-model="form.nuevaContrasena" :disabled="!editando" placeholder="Solo si deseas cambiarla">
            </div>
        </div>

        <button v-if="!editando" @click="iniciarEdicion">Editar Perfil</button>
        <div v-else>
            <button @click="guardarCambios" :disabled="errores.telefono || guardando">
                {{ guardando ? 'Guardando...' : 'Guardar Cambios' }}
            </button>
            <button @click="cancelarEdicion" style="margin-top:8px; background:#999;">
                Cancelar
            </button>
        </div>

        <div class="debug" v-if="debug">{{ debug }}</div>
    </div>
</div>

<script>
const app = Vue.createApp({
    data() {
        return {
            ciEmpleado: localStorage.getItem("ciEmpleado"),
            editando: false,
            guardando: false,
            backup: {},
            form: {
                nombre1: "", nombre2: "", apellidoP: "", apellidoM: "",
                correo: "", telefono: "", direccion: "", nuevaContrasena: ""
            },
            errores: { telefono: "" },
            debug: ""
        };
    },
    mounted() {
        if (!this.ciEmpleado) {
            alert("Debes iniciar sesión primero");
            window.location.href = "../login.html";
            return;
        }
        this.cargarPerfil();
    },
    methods: {
        validarTelefono() {
            const t = this.form.telefono.trim();
            this.errores.telefono = (t === "" || /^\d{7,10}$/.test(t)) ? "" : "Teléfono debe tener 7-10 dígitos";
        },
        cargarPerfil() {
            this.debug = "Cargando perfil...";
            // CAMBIO 1: Ahora usamos accion=cargar
            fetch(`../../backend/perfil_admin.php?accion=cargar&ci=${this.ciEmpleado}`, { 
                credentials: "include" 
            })
                .then(r => r.json())
                .then(res => {
                    if (res.success && res.data) {
                        this.form = { ...res.data, nuevaContrasena: "" };
                        this.backup = { ...this.form };
                        this.debug += "\nPerfil cargado correctamente";
                    } else {
                        alert("Error al cargar perfil: " + (res.message || "Desconocido"));
                        this.debug += "\nError del servidor: " + JSON.stringify(res);
                    }
                })
                .catch(e => {
                    this.debug += "\nError de red: " + e;
                    alert("Error de conexión");
                });
        },
        iniciarEdicion() {
            this.editando = true;
            this.backup = { ...this.form };
        },
        cancelarEdicion() {
            this.form = { ...this.backup };
            this.editando = false;
            this.errores.telefono = "";
        },
        guardarCambios() {
            if (this.errores.telefono) return alert("Corrija el teléfono");

            this.guardando = true;

            const payload = {
                accion: "actualizar",           // CAMBIO 2: Enviamos la acción
                ciEmpleado: this.ciEmpleado,
                ...this.form
            };

            // Si no hay nueva contraseña, la quitamos del payload
            if (!payload.nuevaContrasena.trim()) {
                delete payload.nuevaContrasena;
            }

            this.debug += "\n\nEnviando:\n" + JSON.stringify(payload, null, 2);

            // CAMBIO 3: Apunta al nuevo archivo y envía accion
            fetch("../../backend/perfil_admin.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(res => {
                this.debug += "\nRespuesta del servidor:\n" + JSON.stringify(res, null, 2);
                if (res.success) {
                    alert("¡Datos guardados correctamente!");
                    this.backup = { ...this.form };
                    this.editando = false;
                } else {
                    alert("Error: " + (res.message || "No se pudo guardar"));
                }
            })
            .catch(e => {
                this.debug += "\nError crítico: " + e;
                alert("Error de conexión");
            })
            .finally(() => this.guardando = false);
        }
    }
});
app.mount("#app");
</script>

</body>
</html>