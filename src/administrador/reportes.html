<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reportes de Ventas | TopSkin Laneige</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #2c3e50, #4a6491);
      min-height: 100vh;
      color: #333;
    }

    /* Header */
    .header {
      padding: 20px 40px;
      text-align: center;
      position: relative;
      background: rgba(0,0,0,0.3);
    }
    
    .header img.logo { height: 80px; }
    
    .perfil {
      position: absolute;
      top: 20px;
      right: 40px;
    }
    
    .perfil img {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: 4px solid white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      object-fit: cover;
    }

    /* Menú */
    .menu {
      padding: 15px 40px;
      display: flex;
      justify-content: center;
      gap: 18px;
      flex-wrap: wrap;
      background: rgba(0,0,0,0.2);
    }
    
    .menu a {
      background: #00bf8f;
      color: white;
      padding: 11px 24px;
      border-radius: 30px;
      text-decoration: none;
      font-size: 14.5px;
      font-weight: 500;
      transition: all 0.3s;
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }
    
    .menu a:hover {
      background: #00a077;
      transform: translateY(-2px);
    }

    /* Contenedor principal */
    .container {
      max-width: 1240px;
      margin: 30px auto;
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    }

    .title {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: white;
      padding: 25px;
      text-align: center;
      font-size: 28px;
      font-weight: 400;
      letter-spacing: 0.5px;
    }

    /* Filtros */
    .filters {
      padding: 25px 40px;
      background: #f8f9fa;
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      font-size: 16px;
    }
    
    .filters label {
      font-weight: bold;
      color: #2c3e50;
    }
    
    select {
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      min-width: 180px;
      background: white;
    }
    
    .btn-buscar {
      background: #2c3e50;
      color: white;
      border: none;
      padding: 12px 32px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }
    
    .btn-buscar:hover { background: #1a2530; }

    /* Contenido principal */
    .content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      padding: 35px 40px;
    }
    
    @media (max-width: 992px) {
      .content { grid-template-columns: 1fr; }
    }

    /* Gráfico */
    .chart-box {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .chart-box h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-size: 20px;
      font-weight: 600;
    }

    /* Lista de ventas */
    .ventas-box {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 12px;
      max-height: 720px;
      overflow-y: auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .ventas-box h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-size: 20px;
      font-weight: 600;
    }

    .venta-item {
      background: white;
      margin-bottom: 22px;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 3px 12px rgba(0,0,0,0.1);
      border-left: 5px solid #00bf8f;
    }
    
    .venta-item h4 {
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 17px;
    }
    
    .venta-item table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      font-size: 15px;
    }
    
    .venta-item table td {
      padding: 8px 0;
      border-bottom: 1px dashed #eee;
    }
    
    .venta-item table td:first-child {
      width: 65%;
      color: #2c3e50;
      font-weight: 500;
    }
    
    .venta-item table td:nth-child(2), 
    .venta-item table td:nth-child(3) {
      text-align: right;
      color: #555;
    }
    
    .total {
      text-align: right;
      font-size: 19px;
      font-weight: bold;
      color: #27ae60;
      margin-top: 12px;
    }
    
    .no-data {
      text-align: center;
      padding: 60px 20px;
      color: #999;
      font-size: 18px;
    }
  </style>
</head>
<body>

<div id="app">
  <div class="header">
    <img src="../../media/logo_1.png" alt="Logo" class="logo">
    <div class="perfil">
      <a href="perfil.html">
        <img src="../../media/perfil.png" alt="Perfil">
      </a>
    </div>
  </div>

  <div class="menu">
    <a href="nuevo_personal.html">Gestión de personal</a>
    <a href="inventario.html">Inventario</a>
    <a href="marcas.html">Marcas</a>
    <a href="reportes.html" class="active">Reportes</a>
    <a href="../menu_admin.html">Menú Admin</a>
  </div>

  <div class="container">
    <div class="title">Reportes de Ventas</div>

    <div class="filters">
      <label>Filtrar por Mes:</label>
      <select v-model="selectedMonth">
        <option value="">Todos los meses del año</option>
        <option value="1">Enero</option>
        <option value="2">Febrero</option>
        <option value="3">Marzo</option>
        <option value="4">Abril</option>
        <option value="5">Mayo</option>
        <option value="6">Junio</option>
        <option value="7">Julio</option>
        <option value="8">Agosto</option>
        <option value="9">Septiembre</option>
        <option value="10">Octubre</option>
        <option value="11">Noviembre</option>
        <option value="12">Diciembre</option>
      </select>
      <button class="btn-buscar" @click="cargarReporte">Buscar</button>
    </div>

    <div class="content">
      <!-- Gráfico Top 6 -->
      <div class="chart-box">
        <h3>Top 6 Productos Más Vendidos</h3>
        <canvas id="pieChart"></canvas>
      </div>

      <!-- Lista de Ventas -->
      <div class="ventas-box">
        <h3>Ventas realizadas en: {{ textoPeriodo }}</h3>

        <div v-if="ventas.length === 0" class="no-data">
          No se encontraron ventas en este período.
        </div>

        <div v-for="v in ventas" :key="v.nFactura" class="venta-item">
          <h4>Factura #{{ v.nFactura }} - {{ formatearFecha(v.fechaVenta) }} - Cliente: {{ v.nombreCliente }}</h4>
          <table>
            <tr v-for="d in v.detalles" :key="d.idDetalleVenta">
              <td>• {{ d.nombreProducto }}</td>
              <td>{{ d.cantidad }} und.</td>
              <td>{{ d.subtotal }} Bs</td>
            </tr>
          </table>
          <div class="total">Monto Total: {{ v.costoTotal }} Bs</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const { createApp, ref, onMounted } = Vue;

createApp({
  setup() {
    const selectedMonth = ref('');
    const ventas = ref([]);
    const top6 = ref([]);
    const textoPeriodo = ref('Cargando...');
    let chart = null;

    const meses = ['', 'Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    const currentYear = new Date().getFullYear();

    const formatearFecha = (fecha) => {
      const f = new Date(fecha);
      return f.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
    };

    const cargarReporte = async () => {
      textoPeriodo.value = 'Cargando...';
      
      const params = new URLSearchParams({
        action: 'reporte',
        month: selectedMonth.value || ''
      });

      try {
        const res = await fetch(`../../backend/reporte.php?${params}`);
        const data = await res.json();

        if (data.error) {
          console.error('Error del servidor:', data);
          textoPeriodo.value = 'Error: ' + data.error;
          ventas.value = [];
          top6.value = [];
        } else {
          ventas.value = data.ventas || [];
          top6.value = data.top6 || [];

          if (selectedMonth.value) {
            textoPeriodo.value = `${meses[parseInt(selectedMonth.value)]} ${currentYear}`;
          } else {
            textoPeriodo.value = `Todo el año ${currentYear}`;
          }
        }
      } catch (e) {
        console.error('Error de red o JSON:', e);
        textoPeriodo.value = 'Error de conexión o datos inválidos';
        ventas.value = [];
        top6.value = [];
      }

      actualizarGrafico();
    };

    const actualizarGrafico = () => {
      const ctx = document.getElementById('pieChart').getContext('2d');
      
      if (chart) chart.destroy();

      if (top6.value.length === 0) {
        ctx.font = "20px Arial";
        ctx.fillStyle = "#999";
        ctx.textAlign = "center";
        ctx.fillText("No hay datos para mostrar", ctx.canvas.width/2, ctx.canvas.height/2);
        return;
      }

      const labels = top6.value.map(p => p.nombre.length > 30 ? p.nombre.substring(0,30)+'...' : p.nombre);
      const datos = top6.value.map(p => p.total_vendido);

      chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: datos,
            backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40'],
            borderColor: '#fff',
            borderWidth: 4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { 
              position: 'bottom',
              labels: { padding: 20, font: { size: 13 } }
            }
          }
        }
      });
    };

    onMounted(() => {
      cargarReporte();
    });

    return { 
      selectedMonth, 
      ventas, 
      top6, 
      textoPeriodo, 
      cargarReporte,
      formatearFecha
    };
  }
}).mount('#app');
</script>

</body>
</html> 