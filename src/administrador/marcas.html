<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proveedores y Marcas | TopSkin Laneige</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(rgba(0,0,0,0.55), rgba(0,0,0,0.75)),
                  url('../../media/fondo-laneige.jpg') center/cover no-repeat fixed;
      min-height: 100vh;
      color: #333;
    }

    .header { padding: 20px 40px; text-align: center; position: relative; background: rgba(0,0,0,0.3); }
    .header img.logo { height: 82px; }
    .perfil { position: absolute; top: 20px; right: 40px; }
    .perfil img { width: 56px; height: 56px; border-radius: 50%; border: 4px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }

    .menu { padding: 15px 40px; display: flex; justify-content: center; gap: 18px; flex-wrap: wrap; background: rgba(0,0,0,0.2); }
    .menu a { background: #00bf8f; color: white; padding: 12px 26px; border-radius: 30px; text-decoration: none; font-size: 14.5px; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.25); transition: all 0.3s; }
    .menu a:hover { background: #00a077; transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.35); }

    .container { max-width: 1280px; margin: 30px auto; background: white; border-radius: 18px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    .title { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 28px; text-align: center; font-size: 30px; font-weight: 400; letter-spacing: 1px; }

    .tabs { display: flex; background: #f1f1f1; border-bottom: 3px solid #ddd; }
    .tab { flex: 1; padding: 18px; text-align: center; font-weight: bold; cursor: pointer; transition: all 0.3s; }
    .tab.active { background: #2c3e50; color: white; }
    .tab:hover:not(.active) { background: #ddd; }

    .tab-content { padding: 45px; display: none; }
    .tab-content.active { display: block; }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 35px; margin-top: 20px; }
    @media (max-width: 992px) { .form-grid { grid-template-columns: 1fr; } }

    .form-group { margin-bottom: 22px; }
    label { display: block; margin-bottom: 10px; font-weight: bold; color: #2c3e50; font-size: 16px; }
    input, select, textarea { width: 100%; padding: 14px 18px; border: 1px solid #ccc; border-radius: 10px; font-size: 16px; transition: border 0.3s; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #00bf8f; box-shadow: 0 0 10px rgba(0,191,143,0.3); }

    /* Campo de código país: solo lectura */
    input[readonly] {
      background: #f0f8ff;
      color: #2c3e50;
      font-weight: bold;
      cursor: default;
    }

    /* Campo de código marca: solo lectura */
    input#codigo-marca {
      background: #e6f7ff;
      color: #0891b2;
      font-weight: bold;
      font-size: 18px;
      letter-spacing: 1px;
      text-align: center;
    }

    .phone-group { display: flex; gap: 12px; align-items: center; }
    .phone-group input:first-child { width: 100px; text-align: center; font-weight: bold; font-size: 18px; }
    .phone-group input:last-child { flex: 1; }

    #map { height: 420px; border-radius: 14px; border: 3px solid #ddd; margin-top: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
    .coords { margin-top: 12px; padding: 14px; background: #f8f9fa; border-radius: 10px; font-family: 'Courier New', monospace; font-size: 15px; color: #2c3e50; border-left: 5px solid #00bf8f; }

    .btn-guardar { background: #00bf8f; color: white; border: none; padding: 16px 40px; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; float: right; margin-top: 20px; box-shadow: 0 6px 15px rgba(0,191,143,0.4); transition: all 0.3s; }
    .btn-guardar:hover { background: #00a077; transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,191,143,0.5); }

    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.75); display: flex; justify-content: center; align-items: center;
      z-index: 9999; animation: fadeIn 0.4s;
    }
    .modal {
      background: white; padding: 40px; border-radius: 20px; text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5); max-width: 420px; width: 90%;
      animation: slideUp 0.5s ease-out;
    }
    .modal h3 { color: #00bf8f; font-size: 28px; margin-bottom: 15px; }
    .modal p { color: #444; font-size: 18px; margin-bottom: 25px; }
    .modal button {
      background: #00bf8f; color: white; border: none; padding: 14px 32px;
      border-radius: 12px; font-size: 17px; font-weight: bold; cursor: pointer;
      transition: all 0.3s;
    }
    .modal button:hover { background: #00a077; transform: translateY(-2px); }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body>

<div id="app">
  <div class="header">
    <img src="../../media/logo_1.png" alt="Logo" class="logo">
    <div class="perfil">
      <img src="../../media/perfil.png" alt="Perfil">
    </div>
  </div>

  <div class="menu">
    <a href="nuevo_personal.html">Gestión de personal</a>
    <a href="inventario.html">Inventario</a>
    <a href="marcas.html" class="active">Marcas y Proveedores</a>
    <a href="reportes.html">Reportes</a>
    <a href="../menu_admin.html">Menú Admin</a>
  </div>

  <div class="container">
    <div class="title">Gestión de Proveedores y Marcas</div>

    <div class="tabs">
      <div class="tab" :class="{active: tab === 'proveedor'}" @click="tab = 'proveedor'">Proveedores</div>
      <div class="tab" :class="{active: tab === 'marca'}" @click="tab = 'marca'">Marcas</div>
    </div>

    <!-- PROVEEDORES -->
    <div class="tab-content" :class="{active: tab === 'proveedor'}">
      <h2 style="color:#2c3e50;margin-bottom:30px;font-size:26px">Registrar Nuevo Proveedor</h2>

      <div class="form-grid">
        <div>
          <div class="form-group">
            <label>ID Proveedor (NIT/RUC)</label>
            <input v-model.trim="prov.idProveedor" placeholder="123456789" required>
          </div>
          <div class="form-group">
            <label>Nombre del Proveedor</label>
            <input v-model.trim="prov.nombre" required>
          </div>
          <div class="form-group">
            <label>País</label>
            <select v-model="prov.idPais" @change="actualizarCodigoPais" required>
              <option value="">Seleccione país</option>
              <option v-for="p in paises" :value="p.idPais">{{ p.nombre }}</option>
            </select>
          </div>
          <div class="form-group">
            <label>Teléfono (Código + Número)</label>
            <div class="phone-group">
              <input v-model="prov.codigoPais" readonly placeholder="000">
              <input v-model="prov.telefono" placeholder="71234567" maxlength="10">
            </div>
          </div>
        </div>

        <div>
          <div class="form-group">
            <label>Haz clic en el mapa para ubicar al proveedor</label>
            <div id="map"></div>
            <div class="coords">
              Longitud (X): <strong>{{ prov.X || 'No seleccionada' }}</strong><br>
              Latitud (Y): <strong>{{ prov.Y || 'No seleccionada' }}</strong>
            </div>
          </div>
        </div>
      </div>

      <button class="btn-guardar" @click="guardarProveedor">Guardar Proveedor</button>
    </div>

    <!-- MARCAS -->
    <div class="tab-content" :class="{active: tab === 'marca'}">
      <h2 style="color:#2c3e50;margin-bottom:30px;font-size:26px">Registrar Nueva Marca</h2>

      <div class="form-grid">
        <div>
          <div class="form-group">
            <label>Código de Marca (Automático)</label>
            <input id="codigo-marca" v-model="marca.idMarca" readonly>
          </div>
          <div class="form-group">
            <label>Nombre de la Marca</label>
            <input v-model.trim="marca.nombre" required>
          </div>
        </div>
        <div>
          <div class="form-group">
            <label>País de Origen</label>
            <select v-model="marca.idPais" required>
              <option value="">Seleccione país</option>
              <option v-for="p in paises" :value="p.idPais">{{ p.nombre }}</option>
            </select>
          </div>
          <div class="form-group">
            <label>Descripción</label>
            <textarea v-model="marca.descripcion" rows="5"></textarea>
          </div>
        </div>
      </div>

      <button class="btn-guardar" @click="guardarMarca">Guardar Marca</button>
    </div>
  </div>

  <!-- POPUP DE ÉXITO -->
  <div v-if="popup.visible" class="modal-overlay" @click="popup.visible = false">
    <div class="modal" @click.stop>
      <h3>¡Éxito!</h3>
      <p>{{ popup.mensaje }}</p>
      <button @click="popup.visible = false">Aceptar</button>
    </div>
  </div>
</div>

<script>
const { createApp, ref, onMounted, watch } = Vue;

createApp({
  setup() {
    const tab = ref('proveedor');
    const paises = ref([]);
    const popup = ref({ visible: false, mensaje: '' });

    const prov = ref({
      idProveedor: '', nombre: '', idPais: '', codigoPais: '000', telefono: '', X: '', Y: ''
    });

    const marca = ref({
      idMarca: 'LAN01', nombre: '', idPais: '', descripcion: ''
    });

    let map = null;
    let marker = null;
    const usuarioA = localStorage.getItem('ciEmpleado') || 'ADMIN';

    const cargarPaises = async () => {
      const res = await fetch('../../backend/proveedores_marcas.php?action=paises');
      const data = await res.json();
      paises.value = data;
    };

    const actualizarCodigoPais = () => {
      const paisSeleccionado = paises.value.find(p => p.idPais === prov.value.idPais);
      prov.value.codigoPais = paisSeleccionado ? paisSeleccionado.codigopais_tel : '000';
    };

    const generarSiguienteCodigoMarca = async () => {
      const res = await fetch('../../backend/proveedores_marcas.php?action=siguiente_codigo_marca');
      const data = await res.json();
      marca.value.idMarca = data.siguiente || 'LAN01';
    };

    const initMap = () => {
      if (map) map.remove();
      map = L.map('map').setView([-16.5, -64.0], 5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

      map.on('click', (e) => {
        prov.value.Y = e.latlng.lat.toFixed(6);
        prov.value.X = e.latlng.lng.toFixed(6);
        if (marker) marker.setLatLng(e.latlng);
        else marker = L.marker(e.latlng).addTo(map);
      });
    };

    const mostrarPopup = (msg) => {
      popup.value = { visible: true, mensaje: msg };
    };

    const guardarProveedor = async () => {
      if (!prov.value.idProveedor || !prov.value.nombre || !prov.value.idPais || !prov.value.X) {
        alert('Completa todos los campos obligatorios');
        return;
      }

      const data = { action: 'nuevo_proveedor', usuarioA, ...prov.value };

      const res = await fetch('../../backend/proveedores_marcas.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      if (result.success) {
        prov.value = { idProveedor: '', nombre: '', idPais: '', codigoPais: '000', telefono: '', X: '', Y: '' };
        if (marker) { map.removeLayer(marker); marker = null; }
        initMap();
        mostrarPopup('¡Proveedor registrado exitosamente!');
      } else {
        alert('Error: ' + result.message);
      }
    };

    const guardarMarca = async () => {
      if (!marca.value.nombre || !marca.value.idPais) {
        alert('Completa los campos obligatorios');
        return;
      }

      const data = { action: 'nueva_marca', usuarioA, ...marca.value };

      const res = await fetch('../../backend/proveedores_marcas.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      if (result.success) {
        marca.value = { idMarca: '', nombre: '', idPais: '', descripcion: '' };
        await generarSiguienteCodigoMarca();
        mostrarPopup('¡Marca registrada exitosamente!');
      } else {
        alert('Error: ' + result.message);
      }
    };

    onMounted(() => {
      cargarPaises();
      generarSiguienteCodigoMarca();
      if (tab.value === 'proveedor') initMap();
    });

    watch(tab, (n) => {
      if (n === 'proveedor') setTimeout(initMap, 100);
      if (n === 'marca') generarSiguienteCodigoMarca();
    });

    return {
      tab, paises, prov, marca, popup,
      actualizarCodigoPais, guardarProveedor, guardarMarca
    };
  }
}).mount('#app');
</script>
</body>
</html>