<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asignación de Horarios - TopSkin</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#fdf8f0; font-family:'Segoe UI',Arial,sans-serif; position:relative; min-height:100vh; padding-bottom:80px; }
    header { background:linear-gradient(90deg,#0d9488,#14b8a6); padding:1.2rem 2.5rem; color:white; display:flex; align-items:center; justify-content:space-between; box-shadow:0 6px 25px rgba(0,0,0,0.15); position:relative; z-index:100; }
    .header-left { display:flex; align-items:center; gap:1.8rem; }
    .logo-img { height:56px; }
    .profile-link img { width:56px; height:56px; border-radius:50%; object-fit:cover; border:4px solid rgba(255,255,255,0.3); transition:all 0.3s ease; }
    .profile-link:hover img { transform:scale(1.12); border-color:white; box-shadow:0 8px 20px rgba(0,0,0,0.3); }

    .usuario-info { text-align:left; line-height:1.35; }
    .nombre-usuario { font-weight:600; font-size:1.15rem; color:white; }
    .rol-usuario { font-size:0.95rem; color:rgba(255,255,255,0.92); font-weight:500; }

    nav { display:flex; gap:1.2rem; }
    nav a { background:rgba(255,255,255,0.25); padding:0.7rem 1.4rem; border-radius:2rem; text-decoration:none; color:white; font-weight:500; transition:0.3s; }
    nav a:hover { background:rgba(255,255,255,0.38); }

    .container { max-width:1500px; margin:3rem auto; padding:0 2rem; }
    h1 { font-size:2.4rem; text-align:center; color:#1f2937; margin-bottom:2.5rem; }

    .empleados-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(190px, 1fr)); gap:2.2rem; padding:1rem; }
    .empleado-card { background:white; border-radius:18px; overflow:visible; box-shadow:0 8px 25px rgba(0,0,0,0.1); height:150px; position:relative; transition:all 0.4s ease; cursor:pointer; }
    .compact-info { position:absolute; bottom:0; left:0; right:0; background:white; padding:1rem 0.8rem; text-align:center; border-radius:0 0 18px 18px; }
    .nombre { font-weight:700; font-size:1.05rem; color:#1f2937; }
    .apellido { font-size:0.94rem; color:#4b5563; margin-top:0.4rem; }
    .expanded-info { position:absolute; top:-10px; left:50%; width:220px; height:260px; background:white; border-radius:18px; box-shadow:0 18px 40px rgba(0,0,0,0.22); overflow:hidden; z-index:999; opacity:0; visibility:hidden; transform:translateX(-50%) scale(0.8); transition:all 0.42s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .empleado-card:hover .expanded-info { opacity:1; visibility:visible; transform:translateX(-50%) scale(1); top:-125px; }
    .fondo-foto { height:25%; background:linear-gradient(to bottom,#bae6fd,#e0f2fe); position:relative; }
    .fondo-foto::after { content:""; position:absolute; bottom:0; left:0; right:0; height:28px; background:linear-gradient(to bottom,#86efac,#bbf7d0); }
    .info-expandida { padding:1.3rem 1rem; background:white; text-align:center; height:75%; display:flex; flex-direction:column; justify-content:center; }
    .nombre-full { font-size:1.15rem; font-weight:700; color:#1f2937; margin-bottom:0.6rem; line-height:1.3; }
    .cargo { color:#6b7280; font-size:0.96rem; margin:0.8rem 0 1rem; font-weight:500; }
    .btn-horario { background:#10b981; color:white; border:none; padding:0.62rem 1.6rem; border-radius:2rem; cursor:pointer; font-weight:600; font-size:0.96rem; transition:all 0.3s; }
    .btn-horario:hover { background:#059669; transform:scale(1.07); }

    .horarios-section { margin-top:5rem; background:#f0fdfa; padding:3rem 2.5rem; border-radius:22px; box-shadow:0 12px 35px rgba(0,0,0,0.1); }
    .horarios-title { font-size:2.2rem; color:#134e4a; text-align:center; margin-bottom:1.5rem; font-weight:700; }
    .resumen-empleado { text-align:center; margin-bottom:2rem; padding:1.2rem; background:white; border-radius:16px; box-shadow:0 4px 15px rgba(0,0,0,0.08); font-size:1.1rem; color:#134e4a; font-weight:600; }
    .info-valida { padding:1rem; border-radius:12px; margin:1.5rem 0; text-align:center; font-weight:600; font-size:1.1rem; }
    .valido { background:#d1fae5; color:#065f46; border:1px solid #10b981; }
    .invalido { background:#fee2e2; color:#991b1b; border:1px solid #ef4444; }

    table { width:100%; border-collapse:collapse; background:white; border-radius:16px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.12); margin-top:1rem; }
    th { background:#0d9488; color:white; padding:1.3rem; font-size:1.1rem; font-weight:600; }
    td { padding:1rem; text-align:center; background:#f8f8f8; vertical-align:middle; }
    
    .turno {
      display:block; margin:10px auto; padding:14px 10px; border-radius:12px; cursor:pointer; transition:all 0.3s; font-weight:600;
      width:90%; max-width:180px; position:relative;
    }
    .turno.t1 { background:#dbeafe; color:#1e40af; border:3px solid #3b82f6; }
    .turno.t2 { background:#fef3c7; color:#92400e; border:3px solid #f59e0b; }
    .turno.t3 { background:#fce7f3; color:#9f1239; border:3px solid #ec4899; }

    /* Asignado al empleado actual → Verde fuerte */
    .turno.asignado {
      background:#10b981 !important; color:white !important; border:3px solid #059669 !important;
      box-shadow:0 6px 20px rgba(16,185,129,0.5);
    }

    /* Disponible para asignar → color normal + hover */
    .turno.disponible:hover { transform:scale(1.07); }

    /* Bloqueado (ya hay 2 asignados y NO es del empleado actual) → gris */
    .turno.bloqueado {
      background:#e5e7eb !important; color:#6b7280 !important; cursor:not-allowed; border:3px dashed #94a3b8 !important;
      opacity:0.8;
    }
    .turno.bloqueado::after { content:"Completo (2/2)"; font-size:0.7rem; display:block; margin-top:4px; }

    .btn-guardar-horarios { display:block; margin:2.5rem auto 0; padding:1rem 3.5rem; background:#10b981; color:white; border:none; border-radius:2rem; font-size:1.15rem; font-weight:700; cursor:pointer; transition:0.3s; }
    .btn-guardar-horarios:hover:enabled { background:#059669; transform:translateY(-3px); }
    .btn-guardar-horarios:disabled { background:#94a3b8; cursor:not-allowed; }

    .btn-cerrar-sesion {
      position: fixed; bottom: 30px; right: 30px; background: #dc2626 !important; color: white;
      padding: 14px 28px; font-size: 1.1rem; font-weight: 700; border: none; border-radius: 50px;
      box-shadow: 0 10px 25px rgba(220, 38, 38, 0.4); cursor: pointer; z-index: 9999;
      transition: all 0.3s ease; display: flex; align-items: center; gap: 10px;
    }
    .btn-cerrar-sesion:hover { background: #b91c1c !important; transform: translateY(-4px) scale(1.05); }
  </style>
</head>
<body>

<div id="app" class="container">
  <!-- HEADER (igual) -->
  <header>
    <div class="header-left">
      <a href="administrador/perfil.html" class="profile-link">
        <img src="../media/perfil.png" alt="Mi perfil">
      </a>
      <div class="usuario-info" v-if="usuarioLogueado">
        <div class="nombre-usuario">{{ usuarioLogueado.nombreCompleto }}</div>
        <div class="rol-usuario">{{ usuarioLogueado.rol }}</div>
      </div>
      <img src="../media/logo_1.png" alt="TopSkin Laneige" class="logo-img">
    </div>
    <nav>
      <a href="administrador/nuevo_personal.html">Gestión de nuevo personal</a>      
      <a href="administrador/reportes.html">Reportes</a>
      <a href="administrador/inventario.html">Inventario</a>
      <a href="administrador/marcas.html">Añadir Marcas y Proveedores</a>
    </nav>
  </header>

  <h1>Asignación de Horarios</h1>

  <!-- GRID EMPLEADOS (igual) -->
  <div class="empleados-grid">
    <div v-for="emp in empleados" :key="emp.ciEmpleado" class="empleado-card" @click="seleccionarEmpleado(emp)">
      <div class="compact-info">
        <div class="nombre">{{ emp.nombre1 }} {{ emp.nombre2 || '' }}</div>
        <div class="apellido">{{ emp.apellidoP }} {{ emp.apellidoM || '' }}</div>
      </div>
      <div class="expanded-info">
        <div class="fondo-foto"></div>
        <div class="info-expandida">
          <div class="nombre-full">
            {{ emp.nombre1 }} {{ emp.nombre2 || '' }}<br>
            {{ emp.apellidoP }} {{ emp.apellidoM || '' }}
          </div>
          <div class="cargo">{{ emp.cargo || 'Empleado' }}</div>
          <button class="btn-horario" @click.stop="seleccionarEmpleado(emp)">
            Asignar Horario
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- SECCIÓN HORARIOS -->
  <div v-if="empleadoSeleccionado" class="horarios-section">
    <h2 class="horarios-title">Horario de {{ empleadoSeleccionado.nombreCompleto }}</h2>
    <div class="resumen-empleado">
      Semana del <strong>{{ semanaDel }}</strong> al <strong>{{ semanaAl }}</strong>
    </div>

    <div class="info-valida" :class="horarioValido ? 'valido' : 'invalido'">
      Turnos seleccionados: <strong>{{ totalTurnos }}</strong> (5–12) • 
      Días libres: <strong>{{ diasLibres }}</strong> (mínimo 1)
    </div>

    <table>
      <thead>
        <tr>
          <th>Día</th>
          <th>08:00 - 12:00</th>
          <th>12:00 - 16:00</th>
          <th>16:00 - 20:00</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="dia in diasSemana" :key="dia">
          <td><strong>{{ dia }}</strong><br><small style="color:#0d9488;">{{ fechasDia[dia] }}</small></td>
          <td>
            <div class="turno t1"
                 :class="{
                   asignado: seleccion[dia]?.t1,
                   bloqueado: !disponible[dia]?.t1 && !seleccion[dia]?.t1,
                   disponible: disponible[dia]?.t1
                 }"
                 @click="toggleTurno(dia, 't1')">
              08:00 - 12:00
            </div>
          </td>
          <td>
            <div class="turno t2"
                 :class="{
                   asignado: seleccion[dia]?.t2,
                   bloqueado: !disponible[dia]?.t2 && !seleccion[dia]?.t2,
                   disponible: disponible[dia]?.t2
                 }"
                 @click="toggleTurno(dia, 't2')">
              12:00 - 16:00
            </div>
          </td>
          <td>
            <div class="turno t3"
                 :class="{
                   asignado: seleccion[dia]?.t3,
                   bloqueado: !disponible[dia]?.t3 && !seleccion[dia]?.t3,
                   disponible: disponible[dia]?.t3
                 }"
                 @click="toggleTurno(dia, 't3')">
              16:00 - 20:00
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <button class="btn-guardar-horarios" @click="guardarHorario" :disabled="!horarioValido">
      Guardar Horario (Aprobado automáticamente)
    </button>

    <div v-if="mensaje" style="text-align:center; margin-top:1rem; font-weight:600; color:#0d9488; font-size:1.1rem;">
      {{ mensaje }}
    </div>
  </div>

  <button class="btn-cerrar-sesion" @click="cerrarSesion">Cerrar sesión</button>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

createApp({
  setup() {
    const empleados = ref([]);
    const empleadoSeleccionado = ref(null);
    const seleccion = ref({});
    const disponible = ref({});
    const mensaje = ref('');
    const usuarioLogueado = ref(null);
    const semanaDel = ref('');
    const semanaAl = ref('');
    const fechasDia = ref({});
    const diasSemana = ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado','Domingo'];
    const idSucursal = localStorage.getItem('idSucursal');

    if (!idSucursal || !localStorage.getItem('ciEmpleado')) {
      alert("Sesión expirada");
      location.href = '../login_empleado.html';
    }

    const cerrarSesion = () => {
      if (confirm('¿Cerrar sesión?')) {
        localStorage.clear();
        location.href = '../login_empleado.html';
      }
    };

    const cargarUsuario = async () => {
      const ci = localStorage.getItem('ciEmpleado');
      const r = await fetch(`../backend/menu_admin.php?accion=datos_usuario_logueado&ciEmpleado=${ci}`);
      const d = await r.json();
      if (d.success) usuarioLogueado.value = d;
    };

    const cargarEmpleados = async () => {
      const r = await fetch(`../backend/menu_admin.php?accion=listar_empleados&idSucursal=${idSucursal}`);
      const d = await r.json();
      if (d.success) {
        empleados.value = d.empleados.map(e => ({
          ...e,
          nombreCompleto: `${e.nombre1} ${e.nombre2||''} ${e.apellidoP} ${e.apellidoM||''}`.trim()
        }));
      }
    };

    const calcularSemana = () => {
      const hoy = new Date();
      const lunes = new Date(hoy);
      lunes.setDate(hoy.getDate() - (hoy.getDay() || 7) + 1);
      if (hoy.getDay() === 0) lunes.setDate(lunes.getDate() + 7);
      const dom = new Date(lunes);
      dom.setDate(lunes.getDate() + 6);

      semanaDel.value = lunes.toLocaleDateString('es-ES');
      semanaAl.value = dom.toLocaleDateString('es-ES');

      const temp = new Date(lunes);
      diasSemana.forEach(dia => {
        fechasDia.value[dia] = temp.toLocaleDateString('es-ES', {
          weekday: 'long', day: 'numeric', month: 'short'
        }).replace(/^\w/, c => c.toUpperCase());
        temp.setDate(temp.getDate() + 1);
      });
    };

    const cargarDisponibilidad = async () => {
      const r = await fetch('../backend/editar_horarios.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ accion: 'disponibilidad', idSucursal })
      });
      const d = await r.json();
      if (d.success) disponible.value = d.disp;
    };

    const cargarHorarioActual = async (ci) => {
      const r = await fetch('../backend/editar_horarios.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ accion: 'horario_actual', ciEmpleado: ci })
      });
      const d = await r.json();
      seleccion.value = {};
      if (d.success && d.turnos) {
        d.turnos.forEach(t => {
          const dia = t.dia === 'Miercoles' ? 'Miércoles' : t.dia;
          if (!seleccion.value[dia]) seleccion.value[dia] = {};
          if (t.inicio === '08:00:00') seleccion.value[dia].t1 = true;
          if (t.inicio === '12:00:00') seleccion.value[dia].t2 = true;
          if (t.inicio === '16:00:00') seleccion.value[dia].t3 = true;
        });
      }
    };

    const seleccionarEmpleado = async (emp) => {
      empleadoSeleccionado.value = emp;
      mensaje.value = '';
      seleccion.value = {};
      await cargarDisponibilidad();
      await cargarHorarioActual(emp.ciEmpleado);
    };

    const toggleTurno = (dia, turno) => {
      // Solo permitir si está disponible O ya lo tiene asignado (para deseleccionar)
      if (!disponible.value[dia]?.[turno] && !seleccion.value[dia]?.[turno]) {
        alert("Este turno ya está completo (2 empleados asignados)");
        return;
      }
      if (!seleccion.value[dia]) seleccion.value[dia] = {};
      seleccion.value[dia][turno] = !seleccion.value[dia][turno];
    };

    const totalTurnos = computed(() => {
      let count = 0;
      diasSemana.forEach(d => {
        if (seleccion.value[d]?.t1) count++;
        if (seleccion.value[d]?.t2) count++;
        if (seleccion.value[d]?.t3) count++;
      });
      return count;
    });

    const diasLibres = computed(() => {
      return diasSemana.filter(d => 
        !seleccion.value[d] || (!seleccion.value[d].t1 && !seleccion.value[d].t2 && !seleccion.value[d].t3)
      ).length;
    });

    const horarioValido = computed(() => totalTurnos.value >= 5 && totalTurnos.value <= 12 && diasLibres.value >= 1);

    const guardarHorario = async () => {
      if (!horarioValido.value) {
        alert("Debes asignar entre 5 y 12 turnos, y dejar al menos 1 día libre");
        return;
      }

      const turnos = [];
      diasSemana.forEach(dia => {
        if (seleccion.value[dia]?.t1) turnos.push({ dia, inicio: '08:00:00', fin: '12:00:00' });
        if (seleccion.value[dia]?.t2) turnos.push({ dia, inicio: '12:00:00', fin: '16:00:00' });
        if (seleccion.value[dia]?.t3) turnos.push({ dia, inicio: '16:00:00', fin: '20:00:00' });
      });

      const r = await fetch('../backend/editar_horarios.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          accion: 'guardar_admin',
          ciEmpleado: empleadoSeleccionado.value.ciEmpleado,
          turnos
        })
      });
      const d = await r.json();
      mensaje.value = d.success ? 'Horario guardado y aprobado correctamente!' : d.message;
      if (d.success) await cargarDisponibilidad();
    };

    onMounted(() => {
      calcularSemana();
      cargarEmpleados();
      cargarUsuario();
    });

    return {
      empleados, empleadoSeleccionado, seleccion, disponible, mensaje, usuarioLogueado,
      semanaDel, semanaAl, fechasDia, diasSemana, horarioValido, totalTurnos, diasLibres,
      seleccionarEmpleado, toggleTurno, guardarHorario, cerrarSesion
    };
  }
}).mount('#app');
</script>
</body>
</html>