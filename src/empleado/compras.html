<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compras a Proveedores - TOPSKIN</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Segoe UI',Arial,sans-serif; background:#d8dedf; color:#333; }
    .header {
      background:linear-gradient(135deg,#2c6e49,#4c9a6b);
      background-image:url("../../media/header_empleado.png");
      background-size: cover; 
      color:white; padding:18px 30px; display:flex; align-items:center; justify-content:space-between;
      box-shadow:0 4px 12px rgba(0,0,0,0.15); position:sticky; top:0; z-index:1000;
    }
    .logo{
      width: 150px;
      height: auto;
    }
    .navbar a { color:white; text-decoration:none; padding:10px 18px; border-radius:8px; margin:0 5px; }
    .navbar a:hover, .navbar a.active { background:rgba(255,255,255,0.2); }

    .container { max-width:1300px; margin:40px auto; padding:20px; }
    h1 { color:#0e13107a; text-align:center; margin-bottom:30px; }

    .filtros {
      background:white; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1);
      margin-bottom:25px; display:flex; gap:15px; flex-wrap:wrap; align-items:end;
    }
    .filtros input, .filtros button { padding:12px; border-radius:8px; border:1px solid #ddd; }
    .filtros button { background:#4c749a; color:white; cursor:pointer; }
    .filtros button:hover { background:#737e8d; }

    table { width:100%; border-collapse:collapse; background:white; border-radius:5px; overflow:hidden; box-shadow:0 6px 20px rgba(0,0,0,0.1); }
    th { background:#7aa8ac; color:white; padding:16px; text-align:center; }
    td { padding:16px; text-align:center; border-bottom:1px solid #eee; }
    tr:hover { background:#f8f9fa; }

    .btn { background:#99b1b1; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; }
    .btn:hover { background:#2c6e49; }
    .btn-nuevo { background:#8a8e91; }

    .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:2000; }
    .modal-content { background:white; width:95%; max-width:950px; max-height:90vh; overflow-y:auto; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.4); }
    .modal-header { background:#49858d; color:white; padding:20px; text-align:center; font-size:22px; position:relative; }
    .close { position:absolute; right:20px; top:50%; transform:translateY(-50%); font-size:30px; cursor:pointer; }
    .modal-body { padding:30px; }

    .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px; }
    label { font-weight:600; display:block; margin-bottom:8px; color:#4f705d; }
    input, select { width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; }

    .carrito-item { background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center; }
    .carrito-total { font-size:24px; font-weight:bold; text-align:right; margin-top:20px; color:#2c6a6e; }
  </style>
</head>
<body>

<div id="app">
  <div class="header">
   <img class="logo" src="../../media/logo_1.png">
    <nav class="navbar">
      <a href="../menu_empleado.html">Inicio</a>
      <a href="horarios.html" class="active">Horarios</a>
      <a href="historial_ventas.html">Historial Ventas</a>
      <a href="pedidos.html">Pedidos</a>
      <a href="productos.html">Productos</a>
      <a href="compras.html">Registrar Compra</a>
      <a href="cuenta.html">Mi Cuenta</a>
    </nav>
    <div>{{ empleadoNombre }}</div>
  </div>

  <div class="container">
    <h1>Compras a Proveedores</h1>

    <div class="filtros">
      <div>
        <label>Desde</label>
        <input type="date" v-model="filtroDesde">
      </div>
      <div>
        <label>Hasta</label>
        <input type="date" v-model="filtroHasta">
      </div>
      <button @click="filtrarCompras">Filtrar</button>
      <button class="btn-nuevo" @click="nuevaCompra">+ Nueva Compra</button>
    </div>

    <table v-if="compras.length">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Proveedor</th>
          <th>Total</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="c in compras" :key="c.idCompra">
          <td>{{ formatearFecha(c.fechaCompra) }}</td>
          <td>{{ c.proveedor }}</td>
          <td>{{ parseFloat(c.total).toFixed(2) }} Bs</td>
          <td>
            <button class="btn" @click="verDetalle(c.idCompra)">Ver Detalle</button>
          </td>
        </tr>
      </tbody>
    </table>
    <div v-else style="text-align:center;padding:50px;color:#666;">No hay compras registradas</div>
  </div>

  <div v-if="modalCompra" class="modal" @click.self="modalCompra=false">
    <div class="modal-content">
      <div class="modal-header">
        Registrar Nueva Compra
        <span class="close" @click="modalCompra=false">×</span>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div>
            <label>Proveedor</label>
            <select v-model="compra.proveedor" required>
              <option value="">Seleccione proveedor</option>
              <option v-for="p in proveedores" :value="p.idProveedor">{{ p.nombre }}</option>
            </select>
          </div>
          <div>
            <label>Fecha de Compra</label>
            <input type="date" v-model="compra.fecha" required>
          </div>
        </div>

        <h3 style="margin:25px 0 15px;color:#2c6e49;">Agregar productos</h3>
        <div style="margin-bottom:20px;position:relative;">
          <input 
            v-model="buscarProducto" 
            @input="filtrarProductos"
            @keydown.enter.prevent="agregarPrimerSugerido"
            placeholder="Buscar por nombre o código..." 
            style="width:70%;padding:12px;border-radius:8px;border:1px solid #ddd;"
          >
          <div v-if="sugerencias.length" style="position:absolute;top:100%;left:0;width:70%;background:white;border:1px solid #ddd;border-top:none;border-radius:0 0 8px 8px;max-height:220px;overflow-y:auto;z-index:100;box-shadow:0 5px 15px rgba(0,0,0,0.2);">
            <div v-for="p in sugerencias" :key="p.idProducto" @click="seleccionarProducto(p)" 
                 style="padding:14px;border-bottom:1px solid #eee;cursor:pointer;transition:0.2s;"
                 :style="p.stock < 10 ? 'color:#e74c3c;background:#fff5f5' : 'hover:background:#f0f8f0'">
              <strong>{{ p.nombre }}</strong> 
              <small style="float:right;">Stock: {{ p.stock }} | Precio: {{ parseFloat(p.precioUnitario).toFixed(2) }} Bs</small>
            </div>
          </div>
          <button @click="agregarPrimerSugerido" style="margin-left:10px;padding:12px 20px;" class="btn">+ Agregar</button>
        </div>

        <div v-for="(item, index) in compra.items" :key="index" class="carrito-item">
          <div>
            <strong>{{ item.nombre }}</strong><br>
            <small>Stock actual: {{ item.stock }}</small>
          </div>
          <div style="display:flex;gap:10px;align-items:center;">
            <input type="number" v-model.number="item.cantidad" min="1" style="width:90px;padding:10px;">
            <span>×</span>
            <input type="number" step="0.01" v-model.number="item.precio" min="0" style="width:110px;padding:10px;">
            <span>= {{ (item.cantidad * item.precio).toFixed(2) }} Bs</span>
            <button @click="compra.items.splice(index,1)" style="background:#dc3545;color:white;padding:8px 12px;border:none;border-radius:6px;margin-left:10px;">×</button>
          </div>
        </div>

        <div class="carrito-total">
          TOTAL:{{ totalCompra.toFixed(2) }} Bs
        </div>

        <div style="text-align:center;margin-top:30px;">
          <button @click="guardarCompra" class="btn" :disabled="!compra.proveedor || compra.items.length===0">
            Guardar Compra
          </button>
        </div>
      </div>
    </div>
  </div>

  <div v-if="modalDetalle" class="modal" @click.self="modalDetalle=false">
    <div class="modal-content">
      <div class="modal-header">Detalle Compra #{{ detalle.idCompra }}</div>
      <div class="modal-body">
        <p><strong>Proveedor:</strong> {{ detalle.proveedor }}</p>
        <p><strong>Fecha:</strong> {{ formatearFecha(detalle.fechaCompra) }}</p>
        <p><strong>Total:</strong> {{ parseFloat(detalle.total).toFixed(2) }} Bs</p>
        <table style="width:100%;margin-top:20px;">
          <thead><tr><th>Producto</th><th>Cant.</th><th>Precio</th><th>Subtotal</th></tr></thead>
          <tbody>
            <tr v-for="i in detalle.items">
              <td>{{ i.nombre }}</td>
              <td>{{ i.cantidad }}</td>
              <td>{{ parseFloat(i.precioUnitario).toFixed(2) }} Bs</td>
              <td>{{ (i.cantidad * i.precioUnitario).toFixed(2) }} Bs</td>
            </tr>
          </tbody>
        </table>
        <div style="text-align:center;margin-top:20px;">
          <button @click="modalDetalle=false" class="btn">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

createApp({
  setup() {
    const ciEmpleado = localStorage.getItem('ciEmpleado') || '12345678';
    const empleadoNombre = ref('Empleado');
    const compras = ref([]);
    const proveedores = ref([]);
    const productos = ref([]);
    const filtroDesde = ref('');
    const filtroHasta = ref('');
    const modalCompra = ref(false);
    const modalDetalle = ref(false);
    const detalle = ref({});
    const buscarProducto = ref('');
    const sugerencias = ref([]);

    const compra = ref({
      proveedor: '',
      fecha: new Date().toISOString().split('T')[0],
      items: []
    });

    const totalCompra = computed(() => compra.value.items.reduce((t,i) => t + i.cantidad*i.precio, 0));

    const cargarDatos = async () => {
  const res = await fetch('../../backend/listarcompras.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ciEmpleado: localStorage.getItem('ciEmpleado') || '12345678' })
  });
  const d = await res.json();
  compras.value = d.compras;
  proveedores.value = d.proveedores;
  productos.value = d.productos;
  empleadoNombre.value = d.empleadoNombre;
};

    const filtrarCompras = async () => {
  const res = await fetch('../../backend/listarcompras.php', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      ciEmpleado: localStorage.getItem('ciEmpleado') || '12345678',
      desde: filtroDesde.value,
      hasta: filtroHasta.value
    })
  });
  const d = await res.json();
  compras.value = d.compras;
};

    const nuevaCompra = () => {
      compra.value = { proveedor: '', fecha: new Date().toISOString().split('T')[0], items: [] };
      buscarProducto.value = '';
      sugerencias.value = [];
      modalCompra.value = true;
    };

    const filtrarProductos = () => {
      if (!buscarProducto.value.trim()) { sugerencias.value = []; return; }
      const q = buscarProducto.value.toLowerCase();
      sugerencias.value = productos.value
        .filter(p => p.nombre.toLowerCase().includes(q) || p.idProducto.includes(q.toUpperCase()))
        .slice(0, 8);
    };

    const seleccionarProducto = (p) => {
      if (!compra.value.items.find(i => i.idProducto === p.idProducto)) {
        compra.value.items.push({
          idProducto: p.idProducto,
          nombre: p.nombre,
          stock: p.stock,
          cantidad: 1,
          precio: parseFloat(p.precioUnitario) || 0
        });
      }
      buscarProducto.value = '';
      sugerencias.value = [];
    };

    const agregarPrimerSugerido = () => {
      if (sugerencias.value.length > 0) seleccionarProducto(sugerencias.value[0]);
    };

    const guardarCompra = async () => {
      if (!compra.value.proveedor || compra.value.items.length === 0) return alert("Faltan datos");

      const payload = {
        ciEmpleado,
        proveedor: compra.value.proveedor,
        fechaCompra: compra.value.fecha,
        items: compra.value.items
      };

      const res = await fetch('../../backend/compras.php', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const r = await res.json();
      alert(r.message);
      if (r.success) {
        modalCompra.value = false;
        cargarDatos();
      }
    };

    const verDetalle = async (id) => {
      const res = await fetch('../../backend/detallecompras.php', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({idCompra: id})
      });
      detalle.value = await res.json();
      modalDetalle.value = true;
    };

    const formatearFecha = (f) => f ? new Date(f).toLocaleDateString('es-PE') : '';

    onMounted(cargarDatos);

    return {
      empleadoNombre, compras, proveedores, productos, filtroDesde, filtroHasta,
      modalCompra, modalDetalle, detalle, compra, buscarProducto, sugerencias, totalCompra,
      cargarDatos, filtrarCompras, nuevaCompra, filtrarProductos, seleccionarProducto,
      agregarPrimerSugerido, guardarCompra, verDetalle, formatearFecha
    };
  }
}).mount('#app');
</script>
</body>
</html>