<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carrito de Compras - TopSkin</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="css/carrito.css">
</head>
<body>

<div id="app" class="carrito-wrapper">
  <header class="carrito-header">
    <label class="select-all">
      <input type="checkbox" v-model="todosSeleccionados">
      <span>Todos los artículos</span>
    </label>
    <h1>TOPSKIN</h1>
  </header>

  <div class="carrito-body">
    <div class="productos-lista" v-if="carrito.length > 0">
      <div v-for="item in carrito" :key="item.idProducto" class="producto-item">
        <label class="checkbox-producto">
          <input type="checkbox" 
                 :checked="seleccionados.includes(item.idProducto)"
                 @change="toggleSeleccion(item.idProducto)">
          <span class="checkmark"></span>
        </label>

        <img :src="'img/productos/' + (item.foto || 'placeholder.jpg')" :alt="item.nombre">

        <div class="info-producto">
          <h3>{{ item.nombre }}</h3>
          <p>{{ item.marca || 'Genérico' }}</p>
          <div class="precio-cantidad">
            <span class="precio">Bs. {{ (item.precioUnitario * item.cantidad).toFixed(2) }}</span>
            <div class="cantidad-controls">
              <button @click="cambiarCantidad(item, -1)" :disabled="item.cantidad <= 1">-</button>
              <span>{{ item.cantidad }}</span>
              <button @click="cambiarCantidad(item, 1)">+</button>
            </div>
          </div>
        </div>

        <button class="btn-eliminar" @click="eliminar(item.idProducto)">
          <i class="fas fa-trash-alt"></i>
        </button>
      </div>
    </div>

    <div v-else class="carrito-vacio">
      <h2>Tu carrito está vacío</h2>
      <a href="catalogo.html">Ir al catálogo</a>
    </div>

    <aside class="resumen-compra">
      <h3>Resumen de la compra</h3>
      <div class="mini-productos">
        <img v-for="prod in productosSeleccionados" 
             :key="prod.idProducto"
             :src="'img/productos/' + (prod.foto || 'placeholder.jpg')">
      </div>

      <div class="linea-total">
        <span>Total:</span>
        <strong>Bs. {{ totalSeleccionado.toFixed(2) }}</strong>
      </div>
      <div class="linea-descuento">
        <span>Descuento:</span>
        <strong>0.00 Bs</strong>
      </div>
      <div class="linea-subtotal">
        <span>Subtotal:</span>
        <strong>Bs. {{ totalSeleccionado.toFixed(2) }}</strong>
      </div>

      <button class="btn-comprar" @click="irAlPago">
        Comprar
      </button>
    </aside>
  </div>
</div>

<script >
    const { createApp } = Vue;

createApp({
  data() {
    return {
      carrito: [],
      seleccionados: []
    }
  },

  computed: {
    todosSeleccionados: {
      get() {
        return this.carrito.length > 0 && this.seleccionados.length === this.carrito.length;
      },
      set(value) {
        this.seleccionados = value ? this.carrito.map(p => p.idProducto) : [];
      }
    },

    productosSeleccionados() {
      return this.carrito.filter(p => this.seleccionados.includes(p.idProducto));
    },

    totalSeleccionado() {
      return this.productosSeleccionados.reduce((sum, p) => {
        return sum + (p.precioUnitario * p.cantidad);
      }, 0);
    }
  },

  methods: {
    cargarCarrito() {
      fetch('../backend/cargar_carrito.php')
        .then(r => r.json())
        .then(data => {
          this.carrito = data;
          this.seleccionados = data.map(p => p.idProducto);
        });
    },

    toggleSeleccion(id) {
      const idx = this.seleccionados.indexOf(id);
      if (idx === -1) this.seleccionados.push(id);
      else this.seleccionados.splice(idx, 1);
    },

    cambiarCantidad(item, delta) {
      const nueva = item.cantidad + delta;
      if (nueva >= 1) {
        item.cantidad = nueva;
        this.guardarCarrito();
      }
    },

    eliminar(id) {
      this.carrito = this.carrito.filter(p => p.idProducto !== id);
      this.seleccionados = this.seleccionados.filter(s => s !== id);
      this.guardarCarrito();
    },

    irAlPago() {
      if (this.seleccionados.length === 0) {
        alert('Por favor selecciona al menos un producto');
        return;
      }
      alert('Redirigiendo al pago con ' + this.seleccionados.length + ' productos...');
    },

    guardarCarrito() {
      const paraBackend = this.carrito.map(p => ({
        idProducto: p.idProducto,
        cantidad: p.cantidad
      }));

      fetch('../backend/actualizar_carrito.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(paraBackend)
      })
      .then(r => r.json())
      .then(res => {
        console.log('Carrito guardado:', res);
      })
      .catch(err => console.error('Error:', err));
    }
  },

  mounted() {
    this.cargarCarrito();
  }

}).mount('#app');
</script>
</body>
</html>
